from typing import List
from pydantic import Field, field_validator
from pydantic_settings import BaseSettings, SettingsConfigDict
from functools import lru_cache
from pathlib import Path


class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        case_sensitive=True,
        extra="ignore",
    )

    APP_NAME: str = "Cloud Companion"
    APP_VERSION: str = "0.1.0"
    DESCRIPTION: str = "AI-Powered Cloud Resource Troubleshooting Assistant"
    DEBUG: bool = Field(default=False, description="Enable debug mode")

    API_V1_PREFIX: str = "/api/v1"
    LOG_LEVEL: str = Field(default="INFO")

    ALLOWED_HOSTS: List[str] = Field(default=["*"])
    CORS_ORIGINS: List[str] = Field(default=["*"])

    @field_validator("ALLOWED_HOSTS", "CORS_ORIGINS", mode="before")
    @classmethod
    def parse_comma_separated(cls, v: str | List[str]) -> List[str]:
        if isinstance(v, str):
            return [item.strip() for item in v.split(",")]
        return v

    NEO4J_URI: str = Field(default="bolt://neo4j:7687")
    NEO4J_USER: str = Field(default="companion")
    NEO4J_PASSWORD: str = Field(default="")
    NEO4J_DATABASE: str = Field(default="neo4j")

    @field_validator("NEO4J_PASSWORD")
    @classmethod
    def validate_neo4j_password(cls, v: str) -> str:
        if not v:
            raise ValueError("NEO4J_PASSWORD cannot be empty")
        return v

    WEAVIATE_URL: str = Field(default="http://weaviate:8080")
    WEAVIATE_API_KEY: str = Field(default="")

    API_HMAC_SECRET: str = Field(default="")

    @field_validator("API_HMAC_SECRET")
    @classmethod
    def validate_api_hmac_secret(cls, v: str) -> str:
        if not v:
            raise ValueError("API_HMAC_SECRET must be set for secure operations")
        return v

    AWS_ACCOUNT_ID: str = Field(default="")
    AZURE_SUBSCRIPTION_ID: str = Field(default="")
    GCP_PROJECT_ID: str = Field(default="")

    class Config:
        env_file = ".env"
        case_sensitive = True


@lru_cache()
def get_settings() -> Settings:
    return Settings()


settings = get_settings()
